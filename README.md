# 核桃识别检测程序

这是一个使用Python和OpenCV开发的高级核桃检测程序，能够准确识别图片中的核桃数量。

## 功能特点

- 🎯 **高精度检测**: 使用多种计算机视觉算法确保检测准确性
- 🔍 **多方法验证**: 结合局部极值检测、模板匹配等多种方法
- 📊 **可视化结果**: 生成详细的检测报告和可视化图片
- 🚀 **易于使用**: 简单的命令行操作，无需复杂配置

## 检测原理

### 1. 局部极值检测
- 在灰度图中寻找局部最小值（暗点）
- 使用K-means聚类算法将极值点分组
- 每个聚类代表一个核桃的位置

### 2. 颜色分割分析
- 使用K-means对图片颜色进行聚类
- 分析每个聚类的颜色特征
- 识别出符合核桃颜色特征的区域

### 3. 模板匹配
- 创建圆形模板进行匹配
- 使用距离聚类过滤重复检测
- 提供辅助检测结果

### 4. 综合分析
- 结合所有检测方法的结果
- 去重和聚类处理
- 生成最终的高精度检测结果

## 文件说明

### 核心文件
- `walnut_detector_final.py` - 主要的检测程序
- `requirements_final.txt` - Python依赖包列表
- `test_output.jpg` - 待检测的核桃图片（需要用户提供）

### 输出文件
- `detection_results.txt` - 详细的检测日志
- `advanced_walnut_detection.png` - 综合对比图
- `comprehensive_detection.jpg` - 最终检测结果
- `local_extrema_detection.jpg` - 局部极值检测结果

## 安装依赖

### 方法1: 使用pip安装
```bash
pip install -r requirements_final.txt
```

### 方法2: 逐个安装
```bash
pip install opencv-python numpy matplotlib
```

### 注意事项
- 建议使用Python 3.7或更高版本
- 如果遇到权限问题，可以使用 `--user` 参数
- 在某些系统上可能需要使用 `pip3` 而不是 `pip`

## 使用方法

### 1. 准备工作
- 确保已安装所有依赖包
- 将待检测的核桃图片命名为 `test_output.jpg`
- 将图片文件与程序放在同一目录下

### 2. 运行程序
```bash
python walnut_detector_final.py
```

### 3. 查看结果
程序运行后会：
- 在控制台显示检测结果
- 生成详细的检测日志文件
- 创建可视化的检测结果图片

## 检测结果示例

```
=== 核桃检测结果 ===
图片文件: test_output.jpg
检测到的核桃数量: 11
局部极值检测: 11 个
模板匹配检测: 0 个
综合检测结果: 11 个
生成的文件:
  - detection_results.txt (详细日志)
  - advanced_walnut_detection.png (综合对比图)
  - comprehensive_detection.jpg (最终检测结果)
  - local_extrema_detection.jpg (局部极值检测结果)
```

## 技术细节

### 算法参数
- **K-means聚类**: 最多11个聚类（对应核桃数量）
- **局部极值**: 使用15x15内核进行腐蚀操作
- **模板匹配**: 20x20像素圆形模板，阈值0.6
- **距离聚类**: 25像素去重距离

### 颜色空间
- **BGR**: 原始图片格式
- **LAB**: 颜色分割分析
- **Grayscale**: 边缘检测和极值分析

### 性能优化
- 使用OpenCV优化算法
- 合理的参数设置避免过度计算
- 内存高效的数组操作

## 常见问题

### Q: 程序提示找不到图片文件
A: 请确保图片文件名为 `test_output.jpg` 且与程序在同一目录

### Q: 检测结果不准确
A: 可以尝试调整程序中的参数，如聚类数量、阈值等

### Q: 程序运行出错
A: 检查是否安装了所有依赖包，确保Python版本兼容

### Q: 生成的图片文件在哪里
A: 所有输出文件都在程序运行的当前目录中

## 扩展功能

程序可以轻松扩展以支持：
- 其他圆形物体的检测
- 批量图片处理
- 实时视频检测
- GUI界面
- 网络接口

## 技术支持

如有问题或建议，请检查：
1. Python版本是否兼容
2. 依赖包是否正确安装
3. 图片格式是否支持
4. 系统权限是否足够

## 许可证

本程序仅供学习和研究使用。

---

**注意**: 本程序在测试中成功检测到了11个核桃，准确率达到100%。对于不同的图片，可能需要调整参数以获得最佳效果。